# Implementation Plan

- [x] 1. PlatformIOプロジェクト基盤とハードウェア抽象化層の構築
  - PlatformIOプロジェクト構造とRaspberry Pi Pico 2用の設定を行う
  - platformio.iniファイルでライブラリ依存関係とビルド設定を構成する
  - 各ハードウェアモジュール用のHAL（Hardware Abstraction Layer）インターフェースを定義する
  - 基本的なログ出力とデバッグ機能を実装する
  - _Requirements: 5.1, 7.1_ **✅ 完成**

- [x] 2. GPS/GNSS通信とPPS信号処理の実装
  - [x] 2.1 I2C通信でZED-F9TからNMEAメッセージを受信する機能を実装
    - I2C初期化とNMEAメッセージパーサーを作成する ✅
    - I2Cストリームレジスタからデータを読み取る機能を実装する ✅
    - GPRMC、GPGGAメッセージから時刻と位置情報を抽出する ✅
    - GPS fix状態と衛星数の監視機能を追加する ✅
    - I2Cバス分離管理（OLED/RTCとの競合回避）を実装する ✅
    - マルチコンステレーション対応（GPS/GLONASS/Galileo/BeiDou/QZSS）✅
    - QZSS L1S災害警報信号処理 ✅
    - _Requirements: 1.1, 1.3_ **✅ 完成**

  - [x] 2.2 PPS信号検出と高精度時刻同期を実装
    - GPIO割り込みでPPS信号のエッジを検出する ✅
    - PPS信号とGPS時刻を同期させる機能を実装する ✅
    - 内部RTCとの時刻差分計算と補正を行う ✅
    - 高精度時刻取得関数（マイクロ秒精度）✅
    - 非ブロッキング割り込み処理とLED管理 ✅
    - _Requirements: 1.2, 1.3_ **✅ 完成**

  - [x] 2.3 GPS信号喪失時のフォールバック機能を実装
    - GPS信号の品質監視とタイムアウト検出を追加する ✅
    - 内部クロックへのフォールバック処理を実装する ✅
    - GPS信号復旧時の自動再同期機能を作成する ✅
    - Stratum レベル管理（GPS:1, RTC:3）✅
    - 信号品質評価と包括的な状態監視 ✅
    - _Requirements: 1.4_ **✅ 完成**

- [x] 3. イーサネット通信とネットワークスタックの実装
  - [x] 3.1 W5500 SPI通信とイーサネット初期化を実装
    - SPI通信でW5500レジスタの読み書き機能を作成する ✅
    - イーサネットリンクの確立と状態監視を実装する ✅
    - MACアドレス設定とハードウェア初期化を行う ✅
    - 堅牢なエラーハンドリングと診断機能を追加 ✅
    - _Requirements: 4.1, 4.3_ **✅ 完成**

  - [x] 3.2 TCP/IPスタックとソケット管理を実装
    - DHCPクライアント機能または静的IP設定を実装する ✅
    - UDP/TCPソケットの作成と管理機能を追加する ✅
    - ネットワーク切断時の再接続処理を実装する ✅
    - NTP UDP ソケット（ポート123）の自動管理 ✅
    - ネットワーク監視と自動復旧システム ✅
    - _Requirements: 4.2, 4.4_ **✅ 完成**

- [x] 4. NTPサーバー機能の実装
  - [x] 4.1 NTPプロトコルパケット処理を実装
    - NTPv4パケット構造の定義とパース機能を作成する ✅
    - NTP要求の受信とタイムスタンプ処理を実装する ✅
    - 高精度タイムスタンプ生成機能を追加する ✅
    - RFC 5905準拠のNTPv4パケット構造とヘルパーマクロ ✅
    - マイクロ秒精度のタイムスタンプ生成 ✅
    - _Requirements: 2.1_ **✅ 完成**

  - [x] 4.2 NTP応答生成とStratum管理を実装
    - GPS同期状態に基づくStratum レベル設定を実装する ✅
    - NTP応答パケットの生成と送信機能を作成する ✅
    - 複数クライアント同時処理のためのキューイング機能を追加する ✅
    - レート制限とクライアント検証機能 ✅
    - NTP統計収集とPrometheusメトリクス対応 ✅
    - _Requirements: 2.2, 2.3, 2.4_ **✅ 完成**

- [x] 5. ディスプレイ制御とUI実装
  - [x] 5.1 SH1106 OLED制御とグラフィック描画を実装
    - I2C通信でSH1106の初期化と制御を行う ✅
    - 基本的なグラフィック描画機能（文字、線、図形）を実装する ✅
    - 画面レイアウトとページ切り替え機能を作成する ✅
    - プログレスバーとシグナル強度グラフィック表示 ✅
    - 5つの表示モード（GPS時刻、衛星、NTP統計、システム状態、エラー）✅
    - _Requirements: 3.1_ **✅ 完成**

  - [x] 5.2 システム状態表示とリアルタイム更新を実装
    - GPS受信状態（衛星数、信号強度）の表示を実装する ✅
    - 現在時刻とNTP統計情報の表示を追加する ✅
    - エラー状態とアラート表示機能を作成する ✅
    - ボタン制御による表示モード切り替え ✅
    - 起動スプラッシュスクリーンと包括的UI ✅
    - _Requirements: 3.2, 3.3, 3.4_ **✅ 完成**

- [x] 6. 設定管理とWebインターフェース実装
  - [x] 6.1 設定データ構造と永続化を実装
    - 設定データ構造の定義と初期化を行う ✅
    - フラッシュメモリへの設定保存・読み込み機能を実装する ✅
    - 設定値の検証とデフォルト値適用を追加する ✅
    - EEPROMベースの永続化とチェックサム検証 ✅
    - SystemConfig構造体による包括的な設定管理 ✅
    - _Requirements: 5.1, 5.3, 5.4_ **✅ 完成**

  - [x] 6.2 HTTP Webサーバーと設定インターフェースを実装
    - 軽量HTTPサーバーの実装を行う ✅
    - 設定変更用のWebフォームとAPIを作成する ✅
    - 設定変更時の検証と適用処理を実装する ✅
    - HTMLベースの設定表示ページ（/config）✅
    - JSON API エンドポイント（GET/POST /api/config）✅
    - ArduinoJsonによる設定シリアライゼーション ✅
    - _Requirements: 5.2_ **✅ 完成**

**🔧 Critical Bug Fix: GPS 同期問題の修正** 
- SystemMonitorのPPS信号監視をフラグベースからカウントベースに変更 ✅
- GPS信号が良好（57衛星、PPS動作）でもStratum 3を返していた問題を修正 ✅
- フォールバック条件の詳細デバッグログを追加 ✅
- GPS初期化の詳細なエラーメッセージを強化 ✅
- **結果**: GPS同期時はStratum 1、フォールバック時はStratum 3を正しく返すように修正

- [x] 7. ログ機能とSyslog転送の実装
  - [x] 7.1 構造化ログシステムを実装
    - ログレベル管理と構造化ログ生成機能を作成する ✅
    - ローカルログバッファとメモリ管理を実装する ✅
    - ログローテーションと容量制限機能を追加する ✅
    - リンクリストによる効率的なメモリ管理 ✅
    - 8段階のログレベル（DEBUG〜EMERGENCY）✅
    - _Requirements: 7.1_ **✅ 完成**

  - [x] 7.2 Syslogプロトコル実装とリモート転送を実装
    - RFC3164準拠のSyslogメッセージ生成を実装する ✅
    - UDP経由でのSyslogサーバー転送機能を作成する ✅
    - 転送失敗時のバッファリングと再送処理を追加する ✅
    - NTPファシリティによる適切な分類 ✅
    - 包括的なシステム統合（startup、GPS、NTP）✅
    - グローバルログマクロ（LOG_INFO_MSG、LOG_ERR_F等）✅
    - _Requirements: 7.2, 7.3, 7.4_ **✅ 完成**

- [x] 8. Prometheus監視メトリクス実装
  - [x] 8.1 メトリクス収集とデータ構造を実装
    - NTP統計（要求数、応答時間、クライアント数）の収集を実装する ✅
    - GPS精度メトリクス（時刻差分、衛星数、信号品質）を追加する ✅
    - システム状態メトリクス（メモリ使用量、稼働時間）を実装する ✅
    - 包括的なPrometheusMetricsクラス実装 ✅
    - 効率的なメトリクス更新スケジューリング（NTP: 10秒、GPS: 5秒、システム: 30秒）✅
    - _Requirements: 6.1, 6.2_ **✅ 完成**

  - [x] 8.2 Prometheus形式でのメトリクス出力を実装
    - HTTP /metricsエンドポイントを作成する ✅
    - Prometheus形式でのメトリクス出力機能を実装する ✅
    - メトリクスの定期更新とキャッシュ機能を追加する ✅
    - 4KBバッファによる効率的なメトリクス生成 ✅
    - システム健全性スコア計算（0-100%）✅
    - フォールバック機能付きWebエンドポイント ✅
    - _Requirements: 6.3_ **✅ 完成**

- [x] 9. システム統合とエラーハンドリング強化
  - [x] 9.1 全サービス間の連携と状態管理を実装
    - システム全体の状態監視と健全性チェックを実装する ✅
    - 各サービス間の依存関係と初期化順序を管理する ✅
    - 異常検出時の自動復旧処理を追加する ✅
    - SystemController によるシステム状態管理（INITIALIZING → STARTUP → RUNNING → DEGRADED → ERROR → RECOVERY → SHUTDOWN）✅
    - 8つのサービス（GPS、Network、NTP、Display、Config、Logging、Metrics、Hardware）の健全性監視 ✅
    - システム全体の健全性スコア（0-100%）とサービス別健全性チェック ✅
    - _Requirements: 6.4_ **✅ 完成**

  - [x] 9.2 包括的なエラーハンドリングを実装
    - ハードウェア通信エラーの検出と復旧処理を実装する ✅
    - メモリ不足やリソース枯渇への対応を追加する ✅
    - 設定エラーや不正データへの対応を強化する ✅
    - ErrorHandler クラスによる包括的エラー管理（10種類のエラータイプ、5段階の深刻度）✅
    - エラー履歴管理（最大50件）と統計情報収集（解決率、エラー別統計）✅
    - 自動復旧機能とエラー別復旧戦略（再試行、サービス再起動、セーフモード、緊急停止）✅
    - グローバルエラー報告マクロとコールバックシステム ✅
    - main.cpp への統合とリアルタイム監視処理 ✅
    - _Requirements: 5.3_ **✅ 完成**

- [x] 10. テストスイートと品質保証
  - [x] 10.1 ユニットテストの実装
    - GPS NMEAパーサーのテストケースを作成する ✅
    - NTPプロトコル処理のテストを実装する ✅
    - 時刻計算と精度測定のテストを追加する ✅
    - ErrorHandlerとSystemControllerのユニットテストを作成する ✅
    - 包括的なユニットテストスイート（34テストケース、主要機能網羅）✅
    - GPS NMEA解析、NTPプロトコル、時刻精度、エラーハンドリングの完全テスト ✅
    - 32bitオーバーフロー対策とRFC 5905準拠の検証 ✅
    - _Requirements: 1.1, 1.2, 2.1, 2.2_ **✅ 完成**

  - [ ] 10.2 統合テストとシステムテストを実装
    - ハードウェア通信の統合テストを作成する
    - NTPクライアント互換性テストを実装する
    - 長時間動作安定性テストを追加する
    - _Requirements: 2.4, 4.1, 4.2_

- [ ] 11. 最終統合とドキュメント整備
  - [ ] 11.1 システム全体の最終統合テストを実行
    - 全機能の連携動作確認を行う
    - パフォーマンス測定と最適化を実施する
    - セキュリティ設定の検証を行う
    - _Requirements: 全要件_

  - [ ] 11.2 運用ドキュメントとセットアップガイドを作成
    - ハードウェア組み立てとセットアップ手順を文書化する
    - 設定方法と運用手順のドキュメントを作成する
    - トラブルシューティングガイドを整備する
    - _Requirements: 5.2, 5.4_