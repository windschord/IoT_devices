# Implementation Plan

- [x] 1. PlatformIOプロジェクト基盤とハードウェア抽象化層の構築
  - PlatformIOプロジェクト構造とRaspberry Pi Pico 2用の設定を行う
  - platformio.iniファイルでライブラリ依存関係とビルド設定を構成する
  - 各ハードウェアモジュール用のHAL（Hardware Abstraction Layer）インターフェースを定義する
  - 基本的なログ出力とデバッグ機能を実装する
  - _Requirements: 5.1, 7.1_ **✅ 完成**

- [x] 2. GPS/GNSS通信とPPS信号処理の実装
  - [x] 2.1 I2C通信でZED-F9TからNMEAメッセージを受信する機能を実装
    - I2C初期化とNMEAメッセージパーサーを作成する ✅
    - I2Cストリームレジスタからデータを読み取る機能を実装する ✅
    - GPRMC、GPGGAメッセージから時刻と位置情報を抽出する ✅
    - GPS fix状態と衛星数の監視機能を追加する ✅
    - I2Cバス分離管理（OLED/RTCとの競合回避）を実装する ✅
    - マルチコンステレーション対応（GPS/GLONASS/Galileo/BeiDou/QZSS）✅
    - QZSS L1S災害警報信号処理 ✅
    - _Requirements: 1.1, 1.3_ **✅ 完成**

  - [x] 2.2 PPS信号検出と高精度時刻同期を実装
    - GPIO割り込みでPPS信号のエッジを検出する ✅
    - PPS信号とGPS時刻を同期させる機能を実装する ✅
    - 内部RTCとの時刻差分計算と補正を行う ✅
    - 高精度時刻取得関数（マイクロ秒精度）✅
    - 非ブロッキング割り込み処理とLED管理 ✅
    - _Requirements: 1.2, 1.3_ **✅ 完成**

  - [x] 2.3 GPS信号喪失時のフォールバック機能を実装
    - GPS信号の品質監視とタイムアウト検出を追加する ✅
    - 内部クロックへのフォールバック処理を実装する ✅
    - GPS信号復旧時の自動再同期機能を作成する ✅
    - Stratum レベル管理（GPS:1, RTC:3）✅
    - 信号品質評価と包括的な状態監視 ✅
    - _Requirements: 1.4_ **✅ 完成**

- [x] 3. イーサネット通信とネットワークスタックの実装
  - [x] 3.1 W5500 SPI通信とイーサネット初期化を実装
    - SPI通信でW5500レジスタの読み書き機能を作成する ✅
    - イーサネットリンクの確立と状態監視を実装する ✅
    - MACアドレス設定とハードウェア初期化を行う ✅
    - 堅牢なエラーハンドリングと診断機能を追加 ✅
    - _Requirements: 4.1, 4.3_ **✅ 完成**

  - [x] 3.2 TCP/IPスタックとソケット管理を実装
    - DHCPクライアント機能または静的IP設定を実装する ✅
    - UDP/TCPソケットの作成と管理機能を追加する ✅
    - ネットワーク切断時の再接続処理を実装する ✅
    - NTP UDP ソケット（ポート123）の自動管理 ✅
    - ネットワーク監視と自動復旧システム ✅
    - _Requirements: 4.2, 4.4_ **✅ 完成**

- [x] 4. NTPサーバー機能の実装
  - [x] 4.1 NTPプロトコルパケット処理を実装
    - NTPv4パケット構造の定義とパース機能を作成する ✅
    - NTP要求の受信とタイムスタンプ処理を実装する ✅
    - 高精度タイムスタンプ生成機能を追加する ✅
    - RFC 5905準拠のNTPv4パケット構造とヘルパーマクロ ✅
    - マイクロ秒精度のタイムスタンプ生成 ✅
    - _Requirements: 2.1_ **✅ 完成**

  - [x] 4.2 NTP応答生成とStratum管理を実装
    - GPS同期状態に基づくStratum レベル設定を実装する ✅
    - NTP応答パケットの生成と送信機能を作成する ✅
    - 複数クライアント同時処理のためのキューイング機能を追加する ✅
    - レート制限とクライアント検証機能 ✅
    - NTP統計収集とPrometheusメトリクス対応 ✅
    - _Requirements: 2.2, 2.3, 2.4_ **✅ 完成**

- [x] 5. ディスプレイ制御とUI実装
  - [x] 5.1 SH1106 OLED制御とグラフィック描画を実装
    - I2C通信でSH1106の初期化と制御を行う ✅
    - 基本的なグラフィック描画機能（文字、線、図形）を実装する ✅
    - 画面レイアウトとページ切り替え機能を作成する ✅
    - プログレスバーとシグナル強度グラフィック表示 ✅
    - 5つの表示モード（GPS時刻、衛星、NTP統計、システム状態、エラー）✅
    - _Requirements: 3.1_ **✅ 完成**

  - [x] 5.2 システム状態表示とリアルタイム更新を実装
    - GPS受信状態（衛星数、信号強度）の表示を実装する ✅
    - 現在時刻とNTP統計情報の表示を追加する ✅
    - エラー状態とアラート表示機能を作成する ✅
    - ボタン制御による表示モード切り替え ✅
    - 起動スプラッシュスクリーンと包括的UI ✅
    - _Requirements: 3.2, 3.3, 3.4_ **✅ 完成**

- [x] 6. 設定管理とWebインターフェース実装
  - [x] 6.1 設定データ構造と永続化を実装
    - 設定データ構造の定義と初期化を行う ✅
    - フラッシュメモリへの設定保存・読み込み機能を実装する ✅
    - 設定値の検証とデフォルト値適用を追加する ✅
    - EEPROMベースの永続化とチェックサム検証 ✅
    - SystemConfig構造体による包括的な設定管理 ✅
    - _Requirements: 5.1, 5.3, 5.4_ **✅ 完成**

  - [x] 6.2 HTTP Webサーバーと設定インターフェースを実装
    - 軽量HTTPサーバーの実装を行う ✅
    - 設定変更用のWebフォームとAPIを作成する ✅
    - 設定変更時の検証と適用処理を実装する ✅
    - HTMLベースの設定表示ページ（/config）✅
    - JSON API エンドポイント（GET/POST /api/config）✅
    - ArduinoJsonによる設定シリアライゼーション ✅
    - _Requirements: 5.2_ **✅ 完成**

**🔧 Critical Bug Fix: GPS 同期問題の修正** 
- SystemMonitorのPPS信号監視をフラグベースからカウントベースに変更 ✅
- GPS信号が良好（57衛星、PPS動作）でもStratum 3を返していた問題を修正 ✅
- フォールバック条件の詳細デバッグログを追加 ✅
- GPS初期化の詳細なエラーメッセージを強化 ✅
- **結果**: GPS同期時はStratum 1、フォールバック時はStratum 3を正しく返すように修正

- [x] 7. ログ機能とSyslog転送の実装
  - [x] 7.1 構造化ログシステムを実装
    - ログレベル管理と構造化ログ生成機能を作成する ✅
    - ローカルログバッファとメモリ管理を実装する ✅
    - ログローテーションと容量制限機能を追加する ✅
    - リンクリストによる効率的なメモリ管理 ✅
    - 8段階のログレベル（DEBUG〜EMERGENCY）✅
    - _Requirements: 7.1_ **✅ 完成**

  - [x] 7.2 Syslogプロトコル実装とリモート転送を実装
    - RFC3164準拠のSyslogメッセージ生成を実装する ✅
    - UDP経由でのSyslogサーバー転送機能を作成する ✅
    - 転送失敗時のバッファリングと再送処理を追加する ✅
    - NTPファシリティによる適切な分類 ✅
    - 包括的なシステム統合（startup、GPS、NTP）✅
    - グローバルログマクロ（LOG_INFO_MSG、LOG_ERR_F等）✅
    - _Requirements: 7.2, 7.3, 7.4_ **✅ 完成**

- [x] 8. Prometheus監視メトリクス実装
  - [x] 8.1 メトリクス収集とデータ構造を実装
    - NTP統計（要求数、応答時間、クライアント数）の収集を実装する ✅
    - GPS精度メトリクス（時刻差分、衛星数、信号品質）を追加する ✅
    - システム状態メトリクス（メモリ使用量、稼働時間）を実装する ✅
    - 包括的なPrometheusMetricsクラス実装 ✅
    - 効率的なメトリクス更新スケジューリング（NTP: 10秒、GPS: 5秒、システム: 30秒）✅
    - _Requirements: 6.1, 6.2_ **✅ 完成**

  - [x] 8.2 Prometheus形式でのメトリクス出力を実装
    - HTTP /metricsエンドポイントを作成する ✅
    - Prometheus形式でのメトリクス出力機能を実装する ✅
    - メトリクスの定期更新とキャッシュ機能を追加する ✅
    - 4KBバッファによる効率的なメトリクス生成 ✅
    - システム健全性スコア計算（0-100%）✅
    - フォールバック機能付きWebエンドポイント ✅
    - _Requirements: 6.3_ **✅ 完成**

- [x] 9. システム統合とエラーハンドリング強化
  - [x] 9.1 全サービス間の連携と状態管理を実装
    - システム全体の状態監視と健全性チェックを実装する ✅
    - 各サービス間の依存関係と初期化順序を管理する ✅
    - 異常検出時の自動復旧処理を追加する ✅
    - SystemController によるシステム状態管理（INITIALIZING → STARTUP → RUNNING → DEGRADED → ERROR → RECOVERY → SHUTDOWN）✅
    - 8つのサービス（GPS、Network、NTP、Display、Config、Logging、Metrics、Hardware）の健全性監視 ✅
    - システム全体の健全性スコア（0-100%）とサービス別健全性チェック ✅
    - _Requirements: 6.4_ **✅ 完成**

  - [x] 9.2 包括的なエラーハンドリングを実装
    - ハードウェア通信エラーの検出と復旧処理を実装する ✅
    - メモリ不足やリソース枯渇への対応を追加する ✅
    - 設定エラーや不正データへの対応を強化する ✅
    - ErrorHandler クラスによる包括的エラー管理（10種類のエラータイプ、5段階の深刻度）✅
    - エラー履歴管理（最大50件）と統計情報収集（解決率、エラー別統計）✅
    - 自動復旧機能とエラー別復旧戦略（再試行、サービス再起動、セーフモード、緊急停止）✅
    - グローバルエラー報告マクロとコールバックシステム ✅
    - main.cpp への統合とリアルタイム監視処理 ✅
    - _Requirements: 5.3_ **✅ 完成**

- [x] 10. テストスイートと品質保証
  - [x] 10.1 ユニットテストの実装
    - GPS NMEAパーサーのテストケースを作成する ✅
    - NTPプロトコル処理のテストを実装する ✅
    - 時刻計算と精度測定のテストを追加する ✅
    - ErrorHandlerとSystemControllerのユニットテストを作成する ✅
    - 包括的なユニットテストスイート（34テストケース、主要機能網羅）✅
    - GPS NMEA解析、NTPプロトコル、時刻精度、エラーハンドリングの完全テスト ✅
    - 32bitオーバーフロー対策とRFC 5905準拠の検証 ✅
    - _Requirements: 1.1, 1.2, 2.1, 2.2_ **✅ 完成**

  - [x] 10.2 統合テストとシステムテストを実装
    - ハードウェア通信の統合テストを作成する ✅
    - NTPクライアント互換性テストを実装する ✅
    - 長時間動作安定性テストを追加する ✅
    - I2Cバス初期化とデバイススキャニング統合テスト ✅
    - NTPv3/v4クライアント互換性とプロトコル検証 ✅
    - GPS信号安定性と長期メモリ使用量監視テスト ✅
    - 10個の統合・システムテストケース（全て成功） ✅
    - _Requirements: 2.4, 4.1, 4.2_ **✅ 完成**

  - [x] 10.3 ディスプレイサービステストの実装（優先度1）
    - [x] SH1106 OLED初期化テストを作成する ✅
    - [x] ディスプレイモード切り替えテストを実装する ✅
    - [x] GPS受信状態表示テストを追加する ✅
    - [x] エラーメッセージ表示テストを作成する ✅
    - [x] 起動スプラッシュスクリーン表示テストを実装する ✅
    - [x] 画面レイアウト管理テストを追加する ✅
    - 7つの包括的なディスプレイサービステスト（TestDisplayManagerクラス、モック機能付き）✅
    - _Requirements: 3.1, 3.2, 3.3, 3.4_ **✅ 完成**

  - [x] 10.4 設定管理テストの実装（優先度1）
    - [x] 設定ファイル読み込みテストを作成する ✅
    - [x] 設定値検証とバリデーションテストを実装する ✅
    - [x] デフォルト設定フォールバックテストを追加する ✅
    - [x] EEPROM永続化テストを作成する ✅
    - [x] Webインターフェース設定変更テストを実装する ✅
    - [x] JSON API設定エンドポイントテストを追加する ✅
    - TestConfigManagerクラスによる包括的設定管理テスト（6テストケース全て成功）✅
    - EEPROM永続化、設定検証、JSON API、Webインターフェースの完全テスト ✅
    - _Requirements: 5.1, 5.2, 5.3, 5.4_ **✅ 完成**

  - [x] 10.5 ログシステムテストの実装（優先度1）
    - [x] 構造化ログ生成テストを作成する ✅
    - [x] Syslog RFC3164準拠性テストを実装する ✅
    - [x] ローカルログバッファリングテストを追加する ✅
    - [x] Syslogサーバー転送テストを作成する ✅
    - [x] ログレベル管理とフィルタリングテストを実装する ✅
    - [x] ログローテーション機能テストを追加する ✅
    - TestLoggingServiceクラスによる包括的ログシステムテスト（6テストケース成功）✅
    - RFC 3164準拠Syslogメッセージ生成、UDP転送、バッファリング、ローテーション完全テスト ✅
    - TestEthernetUDPモッククラスによるネットワーク転送シミュレーション ✅
    - _Requirements: 7.1, 7.2, 7.3, 7.4_ **✅ 完成**

  - [x] 10.6 W5500イーサネット通信テストの実装（優先度2）
    - [x] W5500 SPI初期化テストを作成する ✅
    - [x] イーサネットリンク検出テストを実装する ✅
    - [x] DHCP IP取得テストを追加する ✅
    - [x] 静的IP設定テストを作成する ✅
    - [x] ネットワーク切断・再接続テストを実装する ✅
    - [x] ソケット管理とUDP通信テストを追加する ✅
    - TestW5500ControllerとTestNetworkManagerクラスによる包括的なW5500イーサネット通信テスト（6テストケース全て成功）✅
    - SPI初期化、ハードウェア検出、DHCP/静的IP設定、リンク監視、ネットワーク切断・再接続、UDP ソケット管理の完全テスト ✅
    - _Requirements: 4.1, 4.2, 4.3, 4.4_ **✅ 完成**

  - [x] 10.7 Prometheusメトリクステストの実装（優先度2）
    - [x] Prometheusメトリクス形式出力テストを作成する ✅
    - [x] HTTP /metricsエンドポイントテストを実装する ✅
    - [x] システム健全性スコア計算テストを追加する ✅
    - [x] メトリクス収集とキャッシュ機能テストを作成する ✅
    - [x] NTP統計メトリクステストを実装する ✅
    - [x] GPS精度メトリクステストを追加する ✅
    - TestPrometheusMetricsとTestHttpServerクラスによる包括的なPrometheusメトリクステスト（6テストケース全て成功）✅
    - NTP/GPS/システムメトリクス形式出力、HTTP /metricsエンドポイント、システム健全性スコア計算、メトリクス収集・キャッシュ機能の完全テスト ✅
    - Prometheus形式準拠（# HELP、# TYPE、メトリクス名、ラベル、値）とコンステレーション別衛星数表示の検証 ✅
    - _Requirements: 6.1, 6.2, 6.3_ **✅ 完成**

- [x] 11. 最終統合とドキュメント整備 **✅ 完成**
  - [x] 11.1 システム全体の最終統合テストを実行
    - [x] 全機能の連携動作確認を行う ✅
    - [x] パフォーマンス測定と最適化を実施する ✅
    - [x] セキュリティ設定の検証を行う ✅
    - IntegratedSystemStateクラスによる包括的なシステム統合テスト（6テストケース全て成功）✅
    - GPS・ネットワーク・NTP・ディスプレイ・設定・ログ・メトリクス・エラーハンドラの完全統合 ✅
    - パフォーマンス測定（応答時間<10ms、メモリ使用率<80%）、ストレステスト、長期安定性テスト（24時間）✅
    - セキュリティテスト（不正要求フィルタ、レート制限）、フェイルオーバーテスト、要件準拠性検証 ✅
    - _Requirements: 全要件_ **✅ 完成**

  - [x] 11.2 運用ドキュメントとセットアップガイドを作成
    - [x] ハードウェア組み立てとセットアップ手順を文書化する ✅
    - [x] 設定方法と運用手順のドキュメントを作成する ✅
    - [x] トラブルシューティングガイドを整備する ✅
    - 包括的な運用ドキュメント群の作成（4つのドキュメント、合計約15,000語）✅
    - ハードウェアセットアップガイド（組み立て手順、配線図、電源設計、安全考慮事項）✅
    - 設定ガイド（Webインターフェース、ネットワーク、GPS/GNSS、NTP、ログ、監視、セキュリティ）✅
    - トラブルシューティングガイド（システム診断、問題別解決手順、高度診断、メンテナンス）✅
    - ドキュメント概要とクイックスタートガイド（システム仕様、プロトコル標準、コミュニティリソース）✅
    - _Requirements: 5.2, 5.4_ **✅ 完成**

## 🔄 設計変更対応タスク（個人利用向け簡素化）

**背景**: 個人利用に適したシンプルな設定システムに設計を変更したため、以下の実装タスクが必要となる。

- [ ] 12. 物理リセットボタン機能の実装
  - [ ] 12.1 Button HAL（ハードウェア抽象化層）を実装
    - GPIO 11でのボタン読み取り機能を作成する
    - デバウンス処理（20ms間隔）を実装する
    - 短押し（<2秒）と長押し（>5秒）の検出機能を追加する
    - ボタンイベントコールバックシステムを実装する
    - 連続押下防止とクールダウン期間を設ける
    - _Requirements: 新規ハードウェア機能_

  - [ ] 12.2 物理リセット機能の統合
    - 短押し時のディスプレイモード切り替え機能を追加する
    - 長押し時の工場出荷時設定リセット機能を実装する
    - 誤操作防止のための確認機構を追加する
    - 既存のディスプレイサービスとの連携を確立する
    - _Requirements: ユーザーインターフェース改良_

- [ ] 13. 簡素化された永続化ストレージの実装
  - [ ] 13.1 Storage HAL（ハードウェア抽象化層）を実装
    - EEPROMエミュレーション（4KBフラッシュ領域）を実装する
    - CRC32チェックサム検証機能を追加する
    - 電源断時書き込み保護機能を実装する
    - 破損データ検出と工場出荷時設定復旧機能を追加する
    - _Requirements: データ永続化の信頼性確保_

  - [ ] 13.2 設定管理システムの簡素化対応
    - 既存の複雑な冗長化機能を削除する
    - シンプルな設定ヘッダー構造に変更する
    - バージョン管理と履歴機能を削除する
    - CRC32検証による基本的な整合性チェックのみ残す
    - _Requirements: 保守性向上とシンプル化_

- [ ] 14. Web設定インターフェースの簡素化
  - [ ] 14.1 不要機能の削除
    - 設定インポート/エクスポート機能を削除する
    - プレビュー機能を削除する
    - 設定変更履歴とロールバック機能を削除する
    - 自動バックアップ機能を削除する
    - _Requirements: シンプルな個人利用設計_

  - [ ] 14.2 基本機能の保持と改良
    - 全設定項目の変更機能を維持する
    - リアルタイム設定検証機能を維持する
    - 設定変更時の即座保存機能を実装する
    - エラーメッセージ表示の改良を行う
    - _Requirements: 基本的な設定変更機能の確保_

- [ ] 15. エラーハンドリングシステムの簡素化
  - [ ] 15.1 設定破損復旧処理の簡素化
    - 複数バックアップからの段階的復旧機能を削除する
    - CRC32不一致時の工場出荷時設定直接復旧を実装する
    - 設定破損ログの簡素化を行う
    - _Requirements: シンプルなエラー復旧_

  - [ ] 15.2 Web設定エラー処理の簡素化
    - 複雑なロールバック処理を削除する
    - 基本的な入力検証とエラーメッセージ表示を維持する
    - 不正設定拒否機能を維持する
    - _Requirements: 基本的なエラー防止機能_

- [ ] 16. 統合テストとドキュメント更新
  - [ ] 16.1 新機能テストの実装
    - Button HALの動作テストを作成する
    - Storage HALのCRC32検証テストを実装する
    - 物理リセットボタンの統合テストを追加する
    - 簡素化された設定管理のテストを実装する
    - _Requirements: 品質保証_

  - [ ] 16.2 ドキュメントの更新
    - ハードウェアセットアップガイドにリセットボタン追加手順を記載する
    - 設定ガイドから削除された機能の説明を除去する
    - トラブルシューティングガイドを簡素化する
    - 個人利用向けのクイックスタートガイドを作成する
    - _Requirements: ドキュメント整合性確保_