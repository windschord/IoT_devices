# GPS NTP Server - ユーザーマニュアル

## 目次

1. [概要](#概要)
2. [初期セットアップ](#初期セットアップ)
3. [Web設定インターフェース](#web設定インターフェース)
4. [設定項目詳細](#設定項目詳細)
5. [システム監視](#システム監視)
6. [トラブルシューティング](#トラブルシューティング)
7. [メンテナンス](#メンテナンス)
8. [FAQ](#faq)

## 概要

GPS NTP ServerはRaspberry Pi Pico 2ベースの高精度時刻同期サーバーです。GPS受信機からのPPS（Pulse Per Second）信号を利用して、ネットワーク内のデバイスに正確な時刻情報を提供します。

### 主な機能

- **高精度時刻同期**: GPS PPS信号による1秒精度の時刻同期
- **マルチコンステレーション対応**: GPS、GLONASS、Galileo、BeiDou、QZSS対応
- **NTPサーバー**: RFC 5905準拠のNTPv4サーバー機能
- **Web設定インターフェース**: ブラウザベースの簡単設定
- **リアルタイム監視**: システム状態とGPS情報の表示
- **Prometheus対応**: メトリクス収集とモニタリング
- **Syslog対応**: ログの集中管理

### システム仕様

- **CPU**: RP2350 150MHz デュアルコア
- **メモリ**: 512KB RAM, 4MB Flash
- **ネットワーク**: イーサネット（W5500）
- **GPS**: SparkFun ZED-F9T（マルチコンステレーション対応）
- **ディスプレイ**: SH1106 OLED（128x64）
- **電源**: USB-C 5V または外部電源

## 初期セットアップ

### 1. ハードウェア接続

詳細な配線については`docs/hardware_setup.md`を参照してください。

**基本接続**:
1. GPS受信機をI2C1（GPIO 6/7）に接続
2. OLEDディスプレイをI2C0（GPIO 0/1）に接続
3. W5500イーサネットモジュールをSPI0に接続
4. イーサネットケーブルを接続
5. GPSアンテナを接続
6. USB-Cで電源供給

### 2. 初回起動

1. **電源投入**: USB-Cケーブルを接続
2. **起動確認**: OLEDディスプレイに起動メッセージが表示
3. **LED確認**: 
   - 緑LED: GPS Fix状態
   - 青LED: ネットワーク接続状態
   - 黄LED: PPS信号状態
   - 赤LED: エラー状態

### 3. ネットワーク設定

**DHCP（推奨）**:
デフォルトでDHCPが有効です。ルーターが自動的にIPアドレスを割り当てます。

**IPアドレス確認方法**:
1. ルーターの管理画面で「gps-ntp-server」を検索
2. OLEDディスプレイでボタンを押してIP情報表示
3. ネットワークスキャンツールを使用

## Web設定インターフェース

### アクセス方法

1. ブラウザを開く
2. IPアドレスを入力（例：`http://192.168.1.100`）
3. Web設定画面が表示

### メイン画面構成

Web設定インターフェースは以下のタブで構成されています：

- **Network**: ネットワーク設定
- **GNSS**: GPS/GNSS設定
- **NTP**: NTPサーバー設定
- **System**: システム設定
- **Status**: システム状態監視

### ナビゲーション

- **タブクリック**: 設定カテゴリの切り替え
- **保存ボタン**: 設定変更の適用
- **リセットボタン**: デフォルト値への復帰
- **ステータス表示**: リアルタイム情報更新（5秒間隔）

## 設定項目詳細

### Network設定

#### Hostname（ホスト名）
- **説明**: ネットワーク上での識別名
- **デフォルト**: `gps-ntp-server`
- **制限**: 英数字とハイフン、63文字以内
- **例**: `my-ntp-server`, `office-timeserver`

#### IP Configuration（IP設定）
**DHCP（推奨）**:
- **説明**: ルーターが自動的にIPアドレスを割り当て
- **利点**: 設定不要、自動管理
- **適用場面**: 一般的な家庭・オフィス環境

**Static IP（固定IP）**:
- **説明**: 手動でIPアドレスを設定
- **利点**: 常に同じIPアドレス
- **適用場面**: サーバー運用、固定アドレスが必要な場合

**Static IP設定項目**:
- **IP Address**: デバイスのIPアドレス（例：192.168.1.100）
- **Netmask**: サブネットマスク（例：255.255.255.0）
- **Gateway**: デフォルトゲートウェイ（例：192.168.1.1）

#### DNS Server
- **説明**: ドメイン名解決用DNSサーバー
- **デフォルト**: ゲートウェイから自動取得
- **設定例**: `8.8.8.8`（Google DNS）

### GNSS設定

#### Constellation Enable（衛星システム有効化）
各衛星システムの有効/無効を設定できます：

**GPS（アメリカ）**:
- **説明**: 最も一般的な衛星測位システム
- **推奨**: 有効（常時）
- **衛星数**: 通常24-32機

**GLONASS（ロシア）**:
- **説明**: ロシアの衛星測位システム
- **推奨**: 有効
- **利点**: 高緯度地域での精度向上

**Galileo（ヨーロッパ）**:
- **説明**: ヨーロッパの衛星測位システム
- **推奨**: 有効
- **利点**: 高精度、信頼性向上

**BeiDou（中国）**:
- **説明**: 中国の衛星測位システム
- **推奨**: 地域により有効
- **注意**: 消費電力が増加する場合があります

**QZSS（日本）**:
- **説明**: 日本の準天頂衛星システム
- **推奨**: 日本国内では有効
- **特徴**: 災害警報機能（L1S信号）

#### GNSS Update Rate（更新レート）
- **1Hz**: 標準設定、消費電力最小
- **5Hz**: 高頻度更新、精度向上
- **10Hz**: 最高頻度、リアルタイム性重視

#### Disaster Alert Settings（災害警報設定）
**QZSS L1S Enabled**:
- **説明**: QZSS L1S災害警報信号の受信
- **対象**: 日本国内のみ有効
- **機能**: 地震、津波、気象警報の受信

**Alert Priority**:
- **High**: 全ての警報を表示
- **Medium**: 重要な警報のみ
- **Low**: 緊急警報のみ

### NTP設定

#### NTP Server Enable
- **説明**: NTPサーバー機能の有効/無効
- **推奨**: 有効
- **影響**: 無効にすると時刻同期サービスが停止

#### NTP Port
- **説明**: NTPサービスのポート番号
- **デフォルト**: 123（標準）
- **変更理由**: ファイアウォール設定、セキュリティポリシー
- **範囲**: 1-65535

#### Stratum Level
- **説明**: NTP階層レベル
- **1**: GPS同期時（最高精度）
- **2**: セカンダリ参照
- **3**: 内部クロック使用時

### System設定

#### Auto Restart
- **説明**: 定期的な自動再起動
- **推奨**: 無効（家庭利用）
- **用途**: 長期間運用でのメモリクリア

#### Restart Interval
- **説明**: 自動再起動の間隔（時間）
- **デフォルト**: 24時間
- **範囲**: 1-168時間（1週間）

#### Debug Mode
- **説明**: デバッグ情報の詳細出力
- **推奨**: 無効（通常運用時）
- **用途**: 問題診断、開発時のみ

### Log設定

#### Syslog Server
- **説明**: Syslogサーバーのアドレス
- **形式**: IPアドレスまたはホスト名
- **例**: `192.168.1.10`, `logserver.local`

#### Syslog Port
- **説明**: Syslogサーバーのポート
- **デフォルト**: 514
- **標準**: 514（UDP）、1514（暗号化）

#### Log Level
ログ出力レベルの設定：

- **0 (DEBUG)**: 全ての情報（開発用）
- **1 (INFO)**: 一般情報（推奨）
- **2 (NOTICE)**: 重要な情報
- **3 (WARNING)**: 警告メッセージ
- **4 (ERROR)**: エラーのみ

## システム監視

### Status画面

**System Information**:
- **Uptime**: システム稼働時間
- **Free Memory**: 使用可能メモリ量
- **Network Status**: ネットワーク接続状態

**GPS Status**:
- **Fix Status**: GPS測位状態
  - No Fix: 測位不可
  - 2D Fix: 2次元測位
  - 3D Fix: 3次元測位（推奨）
- **Satellites**: 衛星数（全体/使用中）
- **Position**: 現在位置（緯度・経度）
- **PPS Status**: PPS信号状態

**NTP Status**:
- **Stratum**: NTP階層レベル
- **Requests**: 処理したNTP要求数
- **Clients**: 現在のクライアント数

### OLED Display

OLEDディスプレイは5つのモードを循環表示：

1. **GPS Time**: GPS時刻と衛星数
2. **Satellites**: コンステレーション別衛星数
3. **NTP Stats**: NTP統計情報
4. **System**: システム状態
5. **Error**: エラー情報（エラー時のみ）

**操作**:
- **短押し（<2秒）**: 表示モード切り替え
- **長押し（>5秒）**: 工場出荷時リセット

### LED Status

**LED1（緑）- GPS Fix**:
- OFF: GPS未接続/信号なし
- 点滅（遅）: GPS接続、測位中
- 点滅（速）: 2D Fix
- 点灯: 3D Fix以上

**LED2（青）- Network**:
- OFF: ネットワーク未接続
- 点灯: ネットワーク接続完了

**LED3（赤）- Error**:
- OFF: 正常動作
- 点灯: 重大エラー発生

**LED4（黄）- PPS**:
- OFF: PPS信号なし
- 短時間点灯: PPS信号受信（1秒間隔）

## トラブルシューティング

### よくある問題と解決方法

#### GPS関連

**問題**: GPS Fixが取得できない
**症状**: 緑LEDが点滅のまま
**原因**:
- GPSアンテナの配置不良
- 屋内での使用
- 衛星信号の遮蔽

**解決方法**:
1. GPSアンテナを窓際に配置
2. 金属製品から離す
3. 屋外での動作確認
4. 10-15分待機（初回測位）

**問題**: 特定の衛星システムが受信できない
**症状**: Status画面で衛星数が少ない
**解決方法**:
1. GNSS設定で該当システムが有効か確認
2. アンテナがマルチバンド対応か確認
3. 地域により一部システムは利用困難

#### ネットワーク関連

**問題**: Web設定画面にアクセスできない
**症状**: ブラウザでタイムアウト
**原因**:
- IPアドレス不明
- ネットワーク設定ミス
- ファイアウォール

**解決方法**:
1. ルーター管理画面でIP確認
2. 同一ネットワークに接続確認
3. ファイアウォール設定確認
4. ケーブル接続確認

**問題**: DHCPでIPアドレス取得できない
**症状**: 青LEDが点灯しない
**解決方法**:
1. イーサネットケーブル確認
2. ルーターのDHCP設定確認
3. 静的IP設定を試行
4. ケーブル・ポート交換

#### NTP関連

**問題**: NTPクライアントが同期しない
**症状**: クライアント側で時刻同期エラー
**原因**:
- GPS未同期でStratum値が高い
- ファイアウォールでポート123がブロック
- ネットワーク到達性

**解決方法**:
1. GPS Fix状態確認（緑LED点灯）
2. Status画面でStratum値確認
3. ファイアウォール設定確認
4. ping接続テスト実行

#### システム関連

**問題**: システムが不安定
**症状**: 頻繁な再起動、応答なし
**原因**:
- 電源不足
- メモリ不足
- ハードウェア不良

**解決方法**:
1. 電源アダプター確認（5V 2A推奨）
2. Status画面でメモリ使用量確認
3. Debug Mode有効化でログ確認
4. 工場出荷時リセット実行

### 詳細診断

#### ログ確認

**Webインターフェース**:
1. Status画面のRecent Eventsセクション
2. 最新10件のログエントリ表示

**Syslogサーバー**:
1. Syslogサーバーでファシリティ「NTP」を確認
2. ログレベル別フィルタリング

#### メトリクス確認

**Prometheus**:
```
http://[IP_ADDRESS]/metrics
```

**主要メトリクス**:
- `gps_satellites_total`: 受信衛星数
- `ntp_requests_total`: NTP要求総数
- `system_uptime_seconds`: システム稼働時間
- `memory_free_bytes`: 空きメモリ

### エラーコード

**GPS関連**:
- `GPS_ERR_1`: GPS初期化失敗
- `GPS_ERR_2`: I2C通信エラー
- `GPS_ERR_3`: PPS信号タイムアウト

**Network関連**:
- `NET_ERR_1`: W5500初期化失敗
- `NET_ERR_2`: DHCP取得失敗
- `NET_ERR_3`: リンク切断

**System関連**:
- `SYS_ERR_1`: メモリ不足
- `SYS_ERR_2`: 設定データ破損
- `SYS_ERR_3`: ハードウェア故障

## メンテナンス

### 定期メンテナンス

#### 月次点検
1. **システム状態確認**:
   - Status画面で稼働状況確認
   - エラーログの確認
   - メモリ使用量チェック

2. **GPS性能確認**:
   - 衛星数と測位精度確認
   - PPS信号の安定性確認
   - アンテナ配置の見直し

#### 年次メンテナンス
1. **清掃**:
   - 基板の埃除去
   - アンテナコネクタ清掃
   - 冷却確保

2. **設定見直し**:
   - ネットワーク設定最適化
   - ログ設定調整
   - 不要機能の無効化

### ファームウェア更新

#### 更新準備
1. 現在の設定をバックアップ
2. 動作中のサービス影響を確認
3. 更新ファイル（.uf2）を準備

#### 更新手順
1. **BOOTSELモード**:
   - BOOTSELボタンを押しながら電源投入
   - PCにUSBストレージとして認識

2. **ファームウェア書き込み**:
   - .uf2ファイルをドライブにコピー
   - 自動的に再起動

3. **動作確認**:
   - 起動後、全機能の動作確認
   - 設定の復旧確認

### バックアップ・復旧

#### 設定バックアップ
現状では手動バックアップのみ対応：
1. 各設定画面の値を記録
2. 重要設定（IP、GNSS、NTP）を優先
3. 定期的な記録更新

#### 工場出荷時リセット

**物理ボタン**:
1. リセットボタンを5秒以上長押し
2. OLED表示で進行状況確認
3. 自動再起動待機

**Web画面**:
1. 各設定画面の「Reset to Defaults」
2. または設定画面の「Factory Reset」

## FAQ

### 基本的な質問

**Q: インターネット接続は必要ですか？**
A: GPS時刻同期には不要です。ただし、以下の機能にはインターネットが必要：
- Syslogサーバーへのログ送信（外部サーバーの場合）
- ファームウェア更新時の情報取得

**Q: 電源断後の復旧時間は？**
A: 通常30秒-2分です：
- システム起動: 30秒
- GPS Fix取得: 30秒-15分（初回/再取得）
- NTPサービス開始: GPS Fix後即座

**Q: 同期精度はどの程度ですか？**
A: 通常運用で±1秒以内、GPS PPS同期時は±1マイクロ秒以内の精度を実現します。

### 技術的な質問

**Q: 対応NTPクライアントは？**
A: RFC 5905準拠のNTPv4クライアント：
- Windows Time Service
- Linux chrony/ntpd
- macOS ntpd
- Cisco/Juniper機器
- その他の標準NTPクライアント

**Q: 最大同時接続クライアント数は？**
A: 推奨50-100クライアント。実際の性能は：
- 要求頻度
- ネットワーク品質
- 他の処理負荷
により変動します。

**Q: GPS以外の時刻源は使用できますか？**
A: 現在はGPS/GNSSのみ対応。将来のバージョンで以下を検討：
- 外部NTPサーバー参照
- RTC（リアルタイムクロック）単独動作
- 手動時刻設定

### トラブルシューティング

**Q: GPS信号が受信できない場合の対処は？**
A: 以下を順番に確認：
1. アンテナが屋外または窓際にあるか
2. アンテナケーブルの接続確認
3. 金属物からの距離（2m以上推奨）
4. 初回は最大15分待機
5. アンテナの故障確認

**Q: NTP同期が不安定な場合は？**
A: 以下をチェック：
1. GPS Fix状態（緑LED点灯）
2. Status画面でStratum値確認
3. ネットワーク接続安定性
4. クライアント側のログ確認
5. ファイアウォール設定

**Q: システムパフォーマンスが低下した場合は？**
A: 以下を実行：
1. Status画面でメモリ使用量確認
2. 不要なGNSSシステム無効化
3. ログレベル調整
4. システム再起動
5. 工場出荷時リセット

---

## サポート情報

**プロジェクトページ**: GitHub Repository
**ドキュメント**: `docs/`フォルダ内の各種文書
**技術仕様**: `design.md`
**ハードウェア情報**: `docs/hardware_setup.md`

**バージョン**: 1.0
**最終更新**: 2025-07-30
**対象ファームウェア**: v1.0.0以降