# GPS NTP Server - PlatformIO Build & Upload Makefile
# Raspberry Pi Pico 2 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨çµ±åˆãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

# å¤‰æ•°å®šç¾©
PIO = pio
ENV = pico
PORT ?= auto
BAUD ?= 9600

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.PHONY: all
all: build

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
.PHONY: help
help:
	@echo "GPS NTP Server - Build & Upload Commands"
	@echo ""
	@echo "Basic Commands:"
	@echo "  make build       - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make upload      - ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
	@echo "  make uploadfs    - ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼ˆHTML/JSï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
	@echo "  make full        - ãƒ“ãƒ«ãƒ‰ + ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ + ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ  ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
	@echo "  make clean       - ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
	@echo ""
	@echo "Development Commands:"
	@echo "  make monitor     - ã‚·ãƒªã‚¢ãƒ«ãƒ¢ãƒ‹ã‚¿ãƒ¼é–‹å§‹ ($(BAUD) baud)"
	@echo "  make test        - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@echo "  make check       - ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã®ã¿ï¼‰"
	@echo ""
	@echo "Advanced Commands:"
	@echo "  make rebuild     - ã‚¯ãƒªãƒ¼ãƒ³ + ãƒ“ãƒ«ãƒ‰"
	@echo "  make flash       - ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
	@echo "  make reset       - ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚»ãƒƒãƒˆ"
	@echo ""
	@echo "File System Commands:"
	@echo "  make fs-build    - ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ"
	@echo "  make fs-check    - data/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª"
	@echo ""
	@echo "Options:"
	@echo "  PORT=<device>    - ã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆæŒ‡å®š (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: auto)"
	@echo "  BAUD=<rate>      - ãƒœãƒ¼ãƒ¬ãƒ¼ãƒˆæŒ‡å®š (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 9600)"
	@echo ""
	@echo "Examples:"
	@echo "  make full                    - å®Œå…¨ãƒ“ãƒ«ãƒ‰&ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
	@echo "  make monitor BAUD=115200     - 115200ãƒœãƒ¼ãƒ¬ãƒ¼ãƒˆã§ãƒ¢ãƒ‹ã‚¿ãƒ¼"
	@echo "  make upload PORT=/dev/ttyACM0 - ç‰¹å®šãƒãƒ¼ãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"

# ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰
.PHONY: build
build:
	@echo "ğŸ”¨ Building GPS NTP Server..."
	$(PIO) run -e $(ENV)
	@echo "âœ… Build completed successfully"

# ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
.PHONY: upload flash
upload flash:
	@echo "ğŸ“¤ Uploading firmware to Raspberry Pi Pico 2..."
	$(PIO) run -e $(ENV) -t upload
	@echo "âœ… Firmware upload completed"

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆHTML/JSï¼‰
.PHONY: uploadfs fs-upload
uploadfs fs-upload:
	@echo "ğŸ“ Checking data directory..."
	@if [ ! -d "data" ]; then \
		echo "âŒ Error: data/ directory not found"; \
		echo "ğŸ’¡ Please ensure data/gps.html and data/gps.js exist"; \
		exit 1; \
	fi
	@if [ ! -f "data/gps.html" ]; then \
		echo "âŒ Error: data/gps.html not found"; \
		exit 1; \
	fi
	@if [ ! -f "data/gps.js" ]; then \
		echo "âŒ Error: data/gps.js not found"; \
		exit 1; \
	fi
	@echo "ğŸ“ Uploading filesystem (HTML/JS files)..."
	$(PIO) run -e $(ENV) -t uploadfs
	@echo "âœ… Filesystem upload completed"

# å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ“ãƒ«ãƒ‰ + ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ + ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼‰
.PHONY: full deploy
full deploy: build upload uploadfs
	@echo ""
	@echo "ğŸ‰ Complete deployment finished!"
	@echo "ğŸ“‹ Summary:"
	@echo "  âœ… Firmware built and uploaded"
	@echo "  âœ… Web files (HTML/JS) uploaded to LittleFS"
	@echo "  ğŸŒ GPS Web interface available at: http://<device-ip>/gps"
	@echo ""
	@echo "ğŸ” Next steps:"
	@echo "  1. Connect to device via 'make monitor'"
	@echo "  2. Check IP address in serial output"
	@echo "  3. Open web browser to access GPS interface"

# ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰
.PHONY: clean
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	$(PIO) run -e $(ENV) -t clean
	@echo "âœ… Clean completed"

# ãƒªãƒ“ãƒ«ãƒ‰ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ + ãƒ“ãƒ«ãƒ‰ï¼‰
.PHONY: rebuild
rebuild: clean build

# ã‚·ãƒªã‚¢ãƒ«ãƒ¢ãƒ‹ã‚¿ãƒ¼
.PHONY: monitor
monitor:
	@echo "ğŸ“º Starting serial monitor ($(BAUD) baud)..."
	@echo "ğŸ’¡ Press Ctrl+C to exit"
	$(PIO) device monitor -b $(BAUD)

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
.PHONY: test
test:
	@echo "ğŸ§ª Running tests..."
	$(PIO) test -e native

# ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã®ã¿ï¼‰
.PHONY: check
check:
	@echo "ğŸ” Checking code (compile only)..."
	$(PIO) check -e $(ENV)

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ é–¢é€£ã‚³ãƒãƒ³ãƒ‰
.PHONY: fs-build
fs-build:
	@echo "ğŸ—‚ï¸ Building filesystem image..."
	$(PIO) run -e $(ENV) -t buildfs
	@echo "âœ… Filesystem image built"

.PHONY: fs-check
fs-check:
	@echo "ğŸ“‹ Checking data directory contents:"
	@if [ -d "data" ]; then \
		find data -type f -name "*.html" -o -name "*.js" -o -name "*.css" | while read file; do \
			size=$$(wc -c < "$$file" 2>/dev/null || echo "0"); \
			echo "  ğŸ“„ $$file ($$size bytes)"; \
		done; \
		echo ""; \
		total_files=$$(find data -type f | wc -l); \
		total_size=$$(find data -type f -exec wc -c {} + 2>/dev/null | tail -1 | awk '{print $$1}' || echo "0"); \
		echo "ğŸ“Š Total: $$total_files files, $$total_size bytes"; \
	else \
		echo "âŒ data/ directory not found"; \
		echo "ğŸ’¡ Run 'mkdir data' and add your web files"; \
	fi

# ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚»ãƒƒãƒˆ
.PHONY: reset
reset:
	@echo "ğŸ”„ Resetting device..."
	$(PIO) device monitor --echo --eol LF --raw -b $(BAUD) | head -1
	@echo "âœ… Device reset completed"

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°
.PHONY: lib-update
lib-update:
	@echo "ğŸ“š Updating libraries..."
	$(PIO) lib update
	@echo "âœ… Libraries updated"

# é–‹ç™ºç”¨å¿«é€Ÿã‚³ãƒãƒ³ãƒ‰
.PHONY: dev
dev: build upload monitor

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
.PHONY: info
info:
	@echo "ğŸ“‹ Project Information:"
	@echo "  Project: GPS NTP Server"
	@echo "  Target: Raspberry Pi Pico 2 (RP2350)"
	@echo "  Environment: $(ENV)"
	@echo "  Framework: Arduino"
	@echo ""
	@echo "ğŸ“Š Project Stats:"
	@$(PIO) run -e $(ENV) --target size || echo "  Run 'make build' first to see size info"
	@echo ""
	@echo "ğŸ“š Dependencies:"
	@$(PIO) lib list | grep -E "(Ethernet|SparkFun|ArduinoJson|LittleFS)" || echo "  Run 'pio lib list' for full dependency list"

# ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰
.PHONY: debug
debug:
	@echo "ğŸ› Building in debug mode..."
	$(PIO) run -e $(ENV) --target debug

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
.PHONY: check-install
check-install:
	@echo "ğŸ” Checking PlatformIO installation..."
	@which $(PIO) > /dev/null || (echo "âŒ PlatformIO not found. Install with: pip install platformio" && exit 1)
	@$(PIO) --version
	@echo "âœ… PlatformIO is ready"

# Makefileã®ä½¿ç”¨æ–¹æ³•ç¢ºèª
.PHONY: usage
usage: help

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãã®å®‰å…¨ãªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
.PHONY: safe-upload
safe-upload:
	@echo "ğŸ›¡ï¸ Safe upload with validation..."
	@echo "1ï¸âƒ£ Building project..."
	@$(MAKE) build
	@echo "2ï¸âƒ£ Checking filesystem..."
	@$(MAKE) fs-check
	@echo "3ï¸âƒ£ Uploading firmware..."
	@$(MAKE) upload
	@echo "4ï¸âƒ£ Uploading filesystem..."
	@$(MAKE) uploadfs
	@echo "âœ… Safe upload completed successfully"

# === Advanced Testing Commands ===

# åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
.PHONY: test-report
test-report:
	@echo "ğŸ“Š Generating comprehensive test report..."
	python3 scripts/generate_test_report.py
	@echo "âœ… Test report generated: test_report.html"

# ä¸¦åˆ—ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
.PHONY: test-parallel
test-parallel:
	@echo "âš¡ Running parallel tests..."
	python3 scripts/parallel_test_runner.py . 4
	@echo "âœ… Parallel tests completed"

# é«˜é€Ÿä¸¦åˆ—ãƒ†ã‚¹ãƒˆï¼ˆ2ãƒ¯ãƒ¼ã‚«ãƒ¼ï¼‰
.PHONY: test-fast
test-fast:
	@echo "ğŸƒ Running fast parallel tests..."
	python3 scripts/parallel_test_runner.py . 2
	@echo "âœ… Fast tests completed"

# ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ
.PHONY: test-cross-platform
test-cross-platform:
	@echo "ğŸŒ Running cross-platform tests..."
	python3 scripts/cross_platform_test.py
	@echo "âœ… Cross-platform tests completed"

# å…¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
.PHONY: test-all
test-all: test test-parallel test-report
	@echo ""
	@echo "ğŸ‰ All test suites completed!"
	@echo "ğŸ“Š Reports available:"
	@echo "  - test_report.html (comprehensive test report)"
	@echo "  - parallel_test_results.json (parallel execution results)"
	@echo ""

# ãƒ†ã‚¹ãƒˆç’°å¢ƒç¢ºèª
.PHONY: test-env
test-env:
	@echo "ğŸ” Checking test environment..."
	@echo "Python version: $$(python3 --version)"
	@echo "PlatformIO: $$($(PIO) --version)"
	@if command -v docker >/dev/null 2>&1; then \
		echo "Docker: $$(docker --version)"; \
	else \
		echo "Docker: Not available"; \
	fi
	@echo ""
	@echo "ğŸ“ Available test environments:"
	@$(PIO) test --list-tests || echo "  Run tests to see available environments"

# ãƒ†ã‚¹ãƒˆçµæœã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
.PHONY: test-clean
test-clean:
	@echo "ğŸ§¹ Cleaning test results..."
	@rm -f test_report.html test_report.json
	@rm -f parallel_test_results.json parallel_test_summary.txt
	@rm -f cross_platform_results.json cross_platform_summary.txt
	@echo "âœ… Test results cleaned"

# CIç’°å¢ƒç”¨ãƒ†ã‚¹ãƒˆ
.PHONY: test-ci
test-ci:
	@echo "ğŸ¤– Running CI tests..."
	@$(MAKE) build
	@$(MAKE) test-fast
	@$(MAKE) test-report
	@echo "âœ… CI tests completed"